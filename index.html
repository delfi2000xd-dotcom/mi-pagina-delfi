<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Delfi - Juegos y Emuladores (SM64 integrado)</title>
    <style>
      :root{
        --bg:#0b0b0f; --card:#121218; --accent:#0af; --muted:#9fb; --text:#e9f3ff;
        --active:#ffd54f; --inactive:#2b2f36;
      }
      html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased}
      header{position:sticky;top:0;background:#111;border-bottom:1px solid rgba(255,255,255,0.03);z-index:40}
      nav{display:flex;gap:10px;justify-content:center;padding:12px}
      nav a{color:var(--accent);text-decoration:none;font-weight:600}
      main{max-width:1100px;margin:18px auto;padding:12px}
      .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.03)}
      h1,h2{margin:8px 0}
      .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
      .btn{background:var(--accent);color:#001;padding:10px 14px;border-radius:8px;text-decoration:none;font-weight:700;border:none;cursor:pointer}
      .btn.alt{background:#09c;color:#001}
      .note{color:var(--muted);font-size:0.95rem}
      .small{font-size:0.9rem;color:var(--muted)}
      /* Games */
      #game-area{width:400px;height:400px;border:2px solid #00f;margin:16px auto;position:relative;background:#111}
      #square{width:40px;height:40px;background:#0f0;position:absolute;cursor:pointer;border-radius:6px}
      #score{ text-align:center; font-size:1.1rem; margin-bottom:8px }
      canvas{display:block;margin:12px auto;border-radius:8px;border:2px solid #234;background:#000}
      /* Key indicators */
      .key-indicators{display:flex;gap:12px;justify-content:center;margin-top:8px;flex-wrap:wrap}
      .keys-block{display:flex;gap:6px;align-items:center}
      .key{width:44px;height:44px;border-radius:8px;background:var(--inactive);display:flex;align-items:center;justify-content:center;color:#000;font-weight:800}
      .key.active{background:var(--active);color:#000;box-shadow:0 6px 18px rgba(255,213,79,0.12)}
      .label{font-size:0.85rem;color:var(--muted);text-align:center;margin-top:6px}
      /* Emulador Infinite Mac */
      .embed-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
      .embed{width:100%;max-width:900px;height:600px;border:1px solid #222;border-radius:8px;display:block;margin:0 auto;background:#000}
      .embed-controls{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
      .kbd-btn{background:rgba(255,255,255,0.04);color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;font-weight:700}
      /* SM64 canvas & log */
      #n64Canvas{width:100%;max-width:900px;height:480px;background:#000;border-radius:8px;border:1px solid #222;display:block;margin:12px auto}
      #log{font-family:monospace;font-size:0.85rem;color:#cfe;max-height:160px;overflow:auto;padding:8px;background:#071018;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
      label.file-label{display:inline-block;padding:10px 12px;border-radius:8px;background:rgba(255,255,255,0.03);cursor:pointer}
      input[type=file]{display:none}
      @media (max-width:720px){ .embed{height:420px} #game-area, canvas, #n64Canvas{width:320px;height:320px} .logo-canal{width:140px;height:140px} }
      /* Touch-action: only on interactive elements */
      #game-area, canvas, .controls, .embed, #embedContainer, #n64Canvas { touch-action: none; }
      main, header, footer, .card { touch-action: auto; }
      /* Hidden input to trigger mobile keyboard */
      #kbdFocus{position:fixed;left:-9999px;top:auto;width:1px;height:1px;opacity:0}
    </style>
  </head>
  <body>
    <header>
      <nav>
        <a href="#inicio">Inicio</a>
        <a href="#canal">Canal</a>
        <a href="#juegos">Juegos</a>
        <a href="#emulador">Infinite Mac</a>
        <a href="#sm64">SM64</a>
        <a href="#contacto">Contacto</a>
      </nav>
    </header>

    <main id="inicio">
      <section class="card center">
        <img src="imagenes/canal.png" alt="Logo" style="width:140px;border-radius:50%;display:block;margin:0 auto 12px">
        <h1 class="center">Hola, soy Delfi</h1>
        <p class="note center">Bienvenido a mi pÃ¡gina con juegos y emuladores. AquÃ­ puedes jugar, embeber Infinite Mac y cargar tu copia legÃ­tima de SM64 para ejecutarla localmente.</p>
      </section>

      <!-- (Se mantienen todas las secciones y juegos exactamente como en v2.2) -->
      <!-- ... (omitido aquÃ­ por brevedad en el ejemplo) ... -->
      <!-- En tu archivo real, conserva todo el HTML de v2.2 tal cual; abajo solo muestro la secciÃ³n SM64 integrada. -->

      <!-- SM64 integrado: secciÃ³n completa -->
      <section id="sm64" class="card">
        <h2>ðŸŽ® Super Mario 64 (integrado)</h2>
        <p class="note">Sube tu copia legÃ­tima (.z64/.n64/.v64). La ROM se ejecuta localmente en tu navegador y no se sube a ningÃºn servidor.</p>

        <div class="row" style="align-items:center">
          <label class="file-label" for="romInput">Seleccionar ROM</label>
          <input id="romInput" type="file" accept=".z64,.n64,.v64" />
          <button id="loadSm64Btn" class="btn" disabled>Cargar ROM en emulador</button>
          <button id="openSm64NewTab" class="btn alt">Abrir en nueva pestaÃ±a</button>
        </div>

        <div style="margin-top:10px">
          <strong>Archivo:</strong> <span id="fileName">â€”</span> Â· <span id="fileSize">â€”</span>
        </div>
        <div style="margin-top:8px">
          <strong>Formato detectado:</strong> <span id="romFormat">â€”</span>
        </div>

        <!-- AquÃ­ intentamos integrar el port SM64 embebido -->
        <div style="margin-top:12px;display:flex;flex-direction:column;align-items:center;gap:8px">
          <div id="sm64EmbedControls" style="display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;">
            <button id="loadSm64Embed" class="btn">Cargar port SM64 embebido</button>
            <button id="sm64Fullscreen" class="btn">Pantalla completa</button>
            <button id="sm64OpenKeyboard" class="kbd-btn">Abrir teclado (mÃ³vil)</button>
          </div>

          <div id="sm64EmbedContainer" style="width:100%;max-width:900px;min-height:120px;display:flex;align-items:center;justify-content:center;">
            <div id="sm64EmbedPlaceholder" style="color:#9fb;text-align:center;padding:18px;">
              Pulsa "Cargar port SM64 embebido" para insertar el port aquÃ­. Si no tienes el port en tu servidor, usa "Abrir en nueva pestaÃ±a" y sube la ROM dentro del port.
            </div>
          </div>

          <canvas id="n64Canvas" width="640" height="480" aria-label="Canvas del emulador N64"></canvas>

          <div style="margin-top:8px">
            <button id="n64Pause" class="btn" style="background:#666">Pausar / Reanudar</button>
          </div>

          <h3 style="margin-top:12px">Registro</h3>
          <div id="log">Estado: esperando ROM...</div>

          <p class="small" style="margin-top:8px">Si el emulador embebido no arranca, abre el port en nueva pestaÃ±a y sube la ROM allÃ­.</p>
        </div>
      </section>

      <section id="contacto" class="card center">
        <h2>ðŸ“² Contacto</h2>
        <p><strong>Roblox:</strong> MVTOEP</p>
        <p><strong>Discord:</strong> dealfi_30409</p>
      </section>
    </main>

    <footer style="text-align:center;color:#a9b7c6;margin:28px 0 60px">Â© 2025 Delfi. v2.2 (SM64 integrado)</footer>

    <input id="kbdFocus" type="text" inputmode="none" aria-hidden="true" />

    <script>
      /************************************************************************
       * ConfiguraciÃ³n
       *
       * Si tienes un port SM64 alojado en tu servidor (misma origen),
       * pon su URL aquÃ­ (por ejemplo: '/sm64/' o '/sm64js/').
       *
       * Si no tienes un port local, deja SM64_PORT_URL = null y usa el iframe
       * para abrir un port pÃºblico en nueva pestaÃ±a (el usuario deberÃ¡ subir la ROM
       * dentro del port).
       ************************************************************************/
      const SM64_PORT_URL = null; // ejemplo: '/sm64/'  (pon la ruta si lo alojas tÃº)

      /* Helpers de log y UI */
      const logEl = document.getElementById('log');
      function log(...args){
        const line = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
        logEl.textContent = line + '\n' + logEl.textContent;
        console.log(...args);
      }
      function detectRomFormat(uint8){
        if(!uint8 || uint8.length<4) return 'desconocido';
        const b0=uint8[0], b1=uint8[1], b2=uint8[2], b3=uint8[3];
        if(b0===0x80 && b1===0x37 && b2===0x12 && b3===0x40) return '.z64 (big-endian)';
        if(b0===0x40 && b1===0x12 && b2===0x37 && b3===0x80) return '.n64 (little-endian)';
        if(b0===0x37 && b1===0x80 && b2===0x40 && b3===0x12) return '.v64 (byte-swapped)';
        return 'posible ROM N64 (encabezado no estÃ¡ndar)';
      }

      /* Elementos */
      const romInput = document.getElementById('romInput');
      const loadSm64Btn = document.getElementById('loadSm64Btn');
      const fileNameEl = document.getElementById('fileName');
      const fileSizeEl = document.getElementById('fileSize');
      const romFormatEl = document.getElementById('romFormat');
      const openSm64NewTab = document.getElementById('openSm64NewTab');
      const n64Canvas = document.getElementById('n64Canvas');
      const sm64EmbedContainer = document.getElementById('sm64EmbedContainer');
      const sm64EmbedPlaceholder = document.getElementById('sm64EmbedPlaceholder');
      const loadSm64Embed = document.getElementById('loadSm64Embed');
      const sm64Fullscreen = document.getElementById('sm64Fullscreen');
      const n64Pause = document.getElementById('n64Pause');

      let romBuffer = null;
      let romFile = null;
      let emulatorInstance = null;
      let paused = false;
      let iframeEl = null;

      romInput.addEventListener('change', async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        romFile = f;
        fileNameEl.textContent = f.name;
        fileSizeEl.textContent = (f.size/1024/1024).toFixed(2) + ' MB';
        try {
          const ab = await f.arrayBuffer();
          const view = new Uint8Array(ab.slice(0, 16));
          const fmt = detectRomFormat(view);
          romFormatEl.textContent = fmt;
          romBuffer = ab;
          loadSm64Btn.disabled = false;
          log('ROM leÃ­da en memoria. Formato detectado:', fmt);
        } catch (err) {
          log('Error leyendo ROM:', err);
          romBuffer = null;
          loadSm64Btn.disabled = true;
        }
      });

      /* Abrir port en nueva pestaÃ±a (fallback) */
      openSm64NewTab.addEventListener('click', () => {
        // Si tienes un port pÃºblico que acepte ROMs, pon su URL aquÃ­.
        // Por defecto abrimos la misma pÃ¡gina en nueva pestaÃ±a para que el usuario
        // pueda usar la interfaz alternativa.
        window.open(window.location.href, '_blank', 'noopener');
      });

      /* Fullscreen canvas */
      sm64Fullscreen.addEventListener('click', () => {
        if (n64Canvas.requestFullscreen) n64Canvas.requestFullscreen();
        else if (n64Canvas.webkitRequestFullscreen) n64Canvas.webkitRequestFullscreen();
        else log('Fullscreen no soportado en este navegador.');
      });

      n64Pause.addEventListener('click', () => {
        paused = !paused;
        n64Pause.textContent = paused ? 'Reanudar' : 'Pausar';
        if (emulatorInstance && typeof emulatorInstance.setPaused === 'function') {
          emulatorInstance.setPaused(paused);
        } else {
          log('Pausa enviada (si el emulador lo soporta).');
        }
      });

      /* Cargar port SM64 embebido (iframe) */
      loadSm64Embed.addEventListener('click', () => {
        if (iframeEl) return;
        // Si tienes SM64_PORT_URL configurado y es del mismo origen, lo insertamos.
        // Si SM64_PORT_URL es null, intentamos cargar un port pÃºblico (no recomendado para pasar ROM).
        const url = SM64_PORT_URL || 'https://sm64js.com/'; // si no tienes local, mostramos sm64js como referencia
        iframeEl = document.createElement('iframe');
        iframeEl.src = url;
        iframeEl.className = 'embed';
        iframeEl.style.width = '100%';
        iframeEl.style.height = '600px';
        iframeEl.loading = 'lazy';
        iframeEl.allow = 'clipboard-write; fullscreen; autoplay';
        iframeEl.title = 'SM64 Port';
        // Reemplazamos placeholder por iframe
        sm64EmbedContainer.removeChild(sm64EmbedPlaceholder);
        sm64EmbedContainer.appendChild(iframeEl);

        // Si el port estÃ¡ en el mismo origen y expone una funciÃ³n para recibir ROMs,
        // intentaremos pasar la ROM por postMessage o llamando a una funciÃ³n global.
        // Nota: cross-origin bloquearÃ¡ el acceso directo; en ese caso el usuario debe subir la ROM dentro del iframe.
        iframeEl.addEventListener('load', () => {
          log('Port SM64 cargado en iframe:', url);
          // Intento de handshake: preguntar al iframe si acepta ROM por postMessage
          try {
            iframeEl.contentWindow.postMessage({ type: 'SM64_PORT_PING', origin: window.location.origin }, '*');
          } catch (err) {
            log('No se pudo enviar mensaje al iframe (cross-origin). Si el iframe estÃ¡ en otro dominio, sube la ROM dentro del port o aloja el port en tu servidor.');
          }
        });
      });

      /* Intento de enviar ROM al iframe por postMessage (si el iframe lo acepta).
         Esto solo funcionarÃ¡ si el iframe implementa un listener que acepte mensajes
         y si la polÃ­tica de cross-origin lo permite. */
      window.addEventListener('message', async (ev) => {
        // Mensajes entrantes desde el iframe
        const msg = ev.data;
        if (!msg || typeof msg !== 'object') return;
        if (msg.type === 'SM64_PORT_REQUEST_ROM') {
          // El iframe solicita la ROM; intentamos enviarla por postMessage con transfer
          if (!romBuffer) {
            ev.source.postMessage({ type: 'SM64_PORT_ROM_MISSING' }, ev.origin);
            log('El port solicitÃ³ la ROM pero no hay ROM cargada en la pÃ¡gina.');
            return;
          }
          try {
            // Transferir ArrayBuffer (si el iframe lo acepta)
            ev.source.postMessage({ type: 'SM64_PORT_ROM', filename: romFile.name, buffer: romBuffer }, ev.origin, [romBuffer]);
            log('ROM enviada al port por postMessage (si el iframe lo acepta).');
            // Nota: despuÃ©s de transferir, romBuffer queda neutro en algunos navegadores; si necesitas volver a usarlo, recarga el archivo.
          } catch (err) {
            // Si no se puede transferir, enviar sin transfer list (mÃ¡s lento)
            try {
              ev.source.postMessage({ type: 'SM64_PORT_ROM', filename: romFile.name, buffer: romBuffer }, ev.origin);
              log('ROM enviada al port por postMessage (sin transfer list).');
            } catch (err2) {
              log('No se pudo enviar la ROM al iframe por postMessage:', err2);
            }
          }
        }
        // Respuestas de handshake
        if (msg.type === 'SM64_PORT_PONG') {
          log('Port SM64 respondiÃ³ al handshake. Si quieres, pulsa "Cargar ROM en emulador" para enviarla.');
        }
      });

      /* BotÃ³n "Cargar ROM en emulador" (intenta usar API global si existe, o postMessage) */
      loadSm64Btn.addEventListener('click', async () => {
        if (!romBuffer) { log('No hay ROM cargada.'); return; }
        log('Intentando iniciar emulador con la ROM...');

        // 1) Si existe una funciÃ³n global startEmulator (port incluido en la misma pÃ¡gina), la usamos
        if (typeof startEmulator === 'function') {
          try {
            emulatorInstance = await startEmulator(romBuffer, n64Canvas, (m) => log('[emu] ' + m));
            log('Emulador iniciado con startEmulator().');
            return;
          } catch (err) {
            log('Error al llamar startEmulator:', err);
          }
        }

        // 2) Si hay un iframe del port y estÃ¡ en el mismo origen, intentamos llamar a una funciÃ³n global dentro del iframe
        if (iframeEl) {
          try {
            // Si el iframe expone window.receiveROMFromParent, llamamos directamente (solo mismo origen)
            if (iframeEl.contentWindow && typeof iframeEl.contentWindow.receiveROMFromParent === 'function') {
              iframeEl.contentWindow.receiveROMFromParent(romBuffer, romFile.name);
              log('Llamada directa a receiveROMFromParent en iframe (mismo origen).');
              return;
            }
          } catch (err) {
            log('No se pudo llamar a receiveROMFromParent en iframe (probablemente cross-origin):', err);
          }

          // 3) Si no hay API directa, pedimos al iframe que solicite la ROM y la enviaremos por postMessage
          try {
            iframeEl.contentWindow.postMessage({ type: 'SM64_PORT_REQUEST_ROM' }, '*');
            log('Se solicitÃ³ al iframe que pida la ROM (postMessage). Si el iframe lo soporta, la recibirÃ¡.');
            return;
          } catch (err) {
            log('No se pudo enviar postMessage al iframe (cross-origin).');
          }
        }

        // 4) Si no hay iframe o no se puede comunicar, mostramos instrucciÃ³n al usuario
        log('No se detectÃ³ un port integrado que acepte la ROM automÃ¡ticamente.');
        log('Opciones: 1) Aloja un port SM64 en el mismo dominio y actualiza SM64_PORT_URL; 2) Abre el port en nueva pestaÃ±a y sube la ROM allÃ­.');
      });

      /* Mostrar errores globales en el log */
      window.addEventListener('error', (e) => log('Error global:', e.message || e));
      window.addEventListener('unhandledrejection', (e) => log('Unhandled rejection:', e.reason || e));
    </script>
  </body>
</html>
